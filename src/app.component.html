
<div class="min-h-screen pb-10 bg-gray-50 text-gray-800" dir="rtl">
  
  <!-- Header -->
  <header class="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-6 shadow-lg rounded-b-3xl mb-8 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
       <!-- Abstract pattern lines -->
       <div class="absolute top-10 left-10 w-32 h-1 bg-yellow-400 transform -rotate-45"></div>
       <div class="absolute bottom-10 right-10 w-48 h-1 bg-red-500 transform -rotate-12"></div>
    </div>
    <div class="relative z-10 container mx-auto text-center">
      <h1 class="text-3xl font-bold mb-2">مسیریاب هوشمند مترو</h1>
      <p class="text-slate-300 text-sm">محاسبه مسیر بهینه با در نظر گرفتن ترافیک ایستگاه‌ها</p>
    </div>
  </header>

  <main class="container mx-auto px-4 max-w-lg">
    
    <!-- Selection Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-gray-100">
      
      <!-- Source Input -->
      <div class="mb-6 relative">
        <label class="block text-sm font-medium text-gray-600 mb-2">ایستگاه مبدا</label>
        <div class="relative">
          <input 
            type="text" 
            class="w-full bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-3.5 pl-10 transition-shadow focus:shadow-md outline-none" 
            placeholder="جستجوی ایستگاه..." 
            [ngModel]="sourceSearch()"
            (ngModelChange)="sourceSearch.set($event); showSourceDropdown.set(true)"
            (focus)="toggleSource()"
          >
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-green-500">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          </div>
        </div>
        
        <!-- Dropdown -->
        @if (showSourceDropdown() && filteredSourceStations().length > 0) {
          <ul class="absolute z-50 w-full bg-white border border-gray-100 rounded-xl shadow-2xl mt-1 max-h-60 overflow-y-auto">
            @for (station of filteredSourceStations(); track station.id) {
              <li 
                (click)="selectSource(station)"
                class="px-4 py-3 hover:bg-blue-50 cursor-pointer flex justify-between items-center border-b border-gray-50 last:border-0 transition-colors"
              >
                <span>{{ station.name }}</span>
                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">شلوغی: {{ station.weight }}</span>
              </li>
            }
          </ul>
        }
      </div>

      <!-- Connecting Line Visual -->
      <div class="flex justify-center -my-3 relative z-0">
         <div class="h-8 w-0.5 bg-gray-200"></div>
      </div>

      <!-- Destination Input -->
      <div class="mb-6 relative z-10">
        <label class="block text-sm font-medium text-gray-600 mb-2">ایستگاه مقصد</label>
        <div class="relative">
          <input 
            type="text" 
            class="w-full bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-xl focus:ring-red-500 focus:border-red-500 block p-3.5 pl-10 transition-shadow focus:shadow-md outline-none" 
            placeholder="جستجوی ایستگاه..." 
            [ngModel]="destSearch()"
            (ngModelChange)="destSearch.set($event); showDestDropdown.set(true)"
            (focus)="toggleDest()"
          >
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-red-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          </div>
        </div>

        <!-- Dropdown -->
        @if (showDestDropdown() && filteredDestStations().length > 0) {
          <ul class="absolute z-50 w-full bg-white border border-gray-100 rounded-xl shadow-2xl mt-1 max-h-60 overflow-y-auto">
             @for (station of filteredDestStations(); track station.id) {
              <li 
                (click)="selectDest(station)"
                class="px-4 py-3 hover:bg-red-50 cursor-pointer flex justify-between items-center border-b border-gray-50 last:border-0 transition-colors"
              >
                <span>{{ station.name }}</span>
                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">شلوغی: {{ station.weight }}</span>
              </li>
            }
          </ul>
        }
      </div>
      
      <!-- Reset Button -->
      @if (sourceId() || destinationId()) {
        <button (click)="reset()" class="w-full py-2 text-sm text-gray-400 hover:text-gray-600 transition-colors">
          پاک کردن فرم
        </button>
      }
    </div>

    <!-- Results Section -->
    @if (calculatedPath(); as result) {
      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden animate-fade-in-up">
        <div class="bg-slate-50 p-4 border-b border-gray-100 flex justify-between items-center">
          <h2 class="font-bold text-slate-700">مسیر پیشنهادی</h2>
          <span class="text-xs font-mono bg-slate-200 text-slate-600 px-2 py-1 rounded">
             امتیاز ترافیک: {{ result.totalWeight }}
          </span>
        </div>
        
        <div class="p-6">
          <div class="relative">
            
            <!-- Stations List -->
            @for (station of result.path; track station.id; let idx = $index, isLast = $last) {
              
              <div class="flex gap-4 relative">
                <!-- Timeline/Connector Column -->
                <div class="flex flex-col items-center w-8">
                  <!-- The Node Circle -->
                  <div class="w-4 h-4 rounded-full border-2 border-white shadow-sm z-10 flex-shrink-0"
                    [class.bg-green-500]="idx === 0"
                    [class.bg-red-500]="isLast"
                    [class.bg-gray-400]="!isLast && idx !== 0"
                  ></div>
                  
                  <!-- The Line Connector -->
                  @if (!isLast) {
                     <div class="w-1 flex-grow my-1 rounded-full relative overflow-hidden bg-gray-200">
                        <!-- Colored segment based on line -->
                        @let lineId = getConnectingLine(station, result.path[idx + 1]);
                        @if (lineId) {
                           <div class="absolute inset-0 w-full h-full" [class]="getLineColor(lineId)"></div>
                        }
                     </div>
                  }
                </div>

                <!-- Content Column -->
                <div class="pb-6 flex-grow">
                   <div class="flex justify-between items-center">
                      <span class="font-bold text-gray-800">{{ station.name }}</span>
                      
                      @if (idx === 0) {
                         <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-md">شروع</span>
                      } @else if (isLast) {
                         <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-md">پایان</span>
                      }
                   </div>
                   
                   <!-- Line Change Info (if next station is on different line than prev) -->
                   <!-- We need to look ahead to see what line connects this station to the next -->
                   @if (!isLast) {
                      @let currentLineId = getConnectingLine(station, result.path[idx + 1]);
                      @if (idx > 0) {
                        @let prevLineId = getConnectingLine(result.path[idx - 1], station);
                        @if (currentLineId !== prevLineId && currentLineId && prevLineId) {
                           <div class="mt-2 text-xs bg-yellow-50 border border-yellow-100 text-yellow-700 p-2 rounded-lg flex items-center gap-2">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                              تغییر خط به: <strong>{{ getLineName(currentLineId) }}</strong>
                           </div>
                        }
                      } @else {
                        <!-- First station, show starting line -->
                         <div class="text-xs text-gray-400 mt-1">
                            حرکت با: {{ getLineName(currentLineId!) }}
                         </div>
                      }
                   }

                   <!-- Traffic indicator -->
                   <div class="mt-1 flex items-center gap-2">
                      <div class="h-1.5 w-16 bg-gray-100 rounded-full overflow-hidden">
                         <div class="h-full bg-slate-400" [style.width.%]="station.weight * 10"></div>
                      </div>
                      <span class="text-[10px] text-gray-400">تراکم: {{ station.weight }}/10</span>
                   </div>
                </div>
              </div>
            }

          </div>
        </div>
      </div>
    }

  </main>
</div>
